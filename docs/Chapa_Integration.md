# Chapa Integration Module

This module (`src/modules/payments/chapa`) ships as a self-contained MVC package that can be plugged into any Express app.

## Folder Overview

```
chapa/
  clients/          # Axios factory with API key + base URL
  http/
    chapa.controller.js
    chapa.routes.js
  models/
    mysql/          # Sequelize transaction model
    mongo/          # Raw payload archive schema
  repositories/     # Dual persistence helpers
  services/         # Business logic (initiate/verify/list)
  validators/       # Joi input schemas
```

## Wiring in Another Project

```js
const initChapaModule = require('./modules/payments/chapa');
const { router } = initChapaModule({
  mysqlConnection,      // existing Sequelize instance
  mongoConnection,      // existing mongoose connection (optional)
  authGuard             // middleware that sets req.user
});

app.use('/payments/chapa', router);
```

- `mysqlConnection` must already have `define` permissions. The module will call `sequelize.define` and reuse the connection’s sync/migrations.
- `mongoConnection` is optional; if omitted, the default mongoose connection is used.
- `authGuard` can be the one exported by the shared auth module or any custom middleware that resolves `req.user.id`.

## Initiating a Payment

Endpoint: `POST /payments/chapa`

```json
{
  "amount": 1500,
  "currency": "ETB",
  "callbackUrl": "https://merchant.app/callback",
  "metadata": {
    "orderId": "ORD-42",
    "customer": "Samuel"
  }
}
```

Validation rules live in `validators/request.schema.js`. Fields:

| Field | Type | Notes |
| --- | --- | --- |
| `amount` | Number | Required, positive |
| `currency` | String(3) | Defaults to `ETB` |
| `callbackUrl` | URL | Required |
| `metadata` | Object | Optional, merged into Chapa payload |
| `reference` | String | Optional; autogenerated UUID if missing |

## Verification

Endpoint: `GET /payments/chapa/:reference`

- Calls Chapa `/transaction/verify/{reference}`.
- Persists verification payload and updates MySQL status (`success` or `failed`).

## Persistence Model

- **MySQL (`chapa_transactions`):** canonical source for amount, status, checkout link, etc.
- **Mongo (`ChapaTransaction` collection):** keeps `rawRequest`, `rawResponse`, and metadata for audits.

## Error Handling

All client failures throw `AppError` with provider-specific context so the global error middleware returns a structured JSON response (status ≥ 400, message, details).
